<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAPA RON'S COFFEE BAY POS</title>
    <style>
        body { font-family: Arial, sans-serif; background: #000; color: #fff; margin: 0; padding: 10px; }
        h1 { text-align: center; color: #d4a373; font-size: 2.5rem; margin: 20px 0; }
        input, button { font-size: 1.8rem; padding: 15px; margin: 10px 0; width: 100%; border-radius: 10px; }
        button { background: #d4a373; color: #000; border: none; cursor: pointer; }
        #items { list-style: none; padding: 0; }
        li { background: #111; padding: 15px; margin: 10px 0; border-radius: 10px; font-size: 1.6rem; }
        #total { font-size: 2.5rem; text-align: center; margin: 20px 0; color: #d4a373; }
        #login, #stockIn, #inventoryView { text-align: center; margin-top: 50px; }
        #pos, #inventoryView { display: none; }
        .stock-info { font-size: 1.4rem; color: #aaa; margin: 15px 0; text-align: center; }
        .low-stock { color: #ff4444; font-weight: bold; }
        #inventoryList { list-style: none; padding: 0; max-height: 70vh; overflow-y: auto; }
        #inventoryList li { background: #111; padding: 12px; margin: 8px 0; border-radius: 8px; font-size: 1.4rem; }
        .in-stock { color: #44ff44; }
        .low-stock-item { color: #ff4444; }
        #scannerVideo { width: 100%; max-width: 400px; border-radius: 10px; margin: 20px 0; display: none; }
    </style>
</head>
<body>
    <h1>PAPA RON'S COFFEE BAY</h1>

    <div id="login">
        <h2>Enter PIN to Start Sale</h2>
        <input type="password" id="pin" placeholder="Your PIN" autofocus />
        <button onclick="login()">Login for Sale</button>
        <button onclick="stockInMode()">Stock In (No PIN)</button>
    </div>

    <div id="pos">
        <button onclick="logout()">Logout</button>
        <button onclick="showInventory()">View Inventory</button>
        <button onclick="startPhoneScanner('sale')">Scan with Phone (Sale)</button>
        <video id="scannerVideo" playsinline autoplay muted></video>
        <input type="text" id="barcode" placeholder="Scan or type barcode" autofocus />
        <button onclick="addItem()">Add to Sale</button>
        <button onclick="clearCart()">Clear Cart</button>
        <button onclick="printReceipt()">Print Receipt</button>
        <button onclick="payAndClear()">Pay & Clear Cart</button>
        <ul id="items"></ul>
        <div id="total">Total: R0.00</div>
        <div id="stockStatus" class="stock-info"></div>
    </div>

    <div id="stockIn" style="display:none;">
        <h2>Stock In Mode</h2>
        <button onclick="logout()">Back to Login</button>
        <button onclick="startPhoneScanner('stock')">Scan with Phone (Stock In)</button>
        <video id="scannerVideoStock" playsinline autoplay muted></video>
        <input type="text" id="stockBarcode" placeholder="Scan incoming stock" autofocus />
        <div id="stockInStatus" class="stock-info"></div>
    </div>

    <div id="inventoryView">
        <h2>Current Inventory</h2>
        <button onclick="backToPOS()">Back to Sale</button>
        <ul id="inventoryList"></ul>
    </div>

    <!-- Sounds from your repo -->
    <audio id="clickSound" src="https://tiffyai-usd.github.io/Papa_Ron_Point_of_Sale/click.wav" preload="auto"></audio>
    <audio id="eatSound" src="https://tiffyai-usd.github.io/Papa_Ron_Point_of_Sale/eat.wav" preload="auto"></audio>
    <audio id="sparkleSound" src="https://tiffyai-usd.github.io/Papa_Ron_Point_of_Sale/sparcle.wav" preload="auto"></audio>

    <!-- QuaggaJS for barcode scanning from camera -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

    <script>
        // Play sounds
        function playClick() { document.getElementById("clickSound").play().catch(() => {}); }
        function playEat() { document.getElementById("eatSound").play().catch(() => {}); }
        function playSparkle() { document.getElementById("sparkleSound").play().catch(() => {}); }

        document.querySelectorAll('button').forEach(btn => btn.addEventListener('click', playClick));

        const STAFF = {
            "1234": "Staff 1",
            "5678": "Staff 2",
            "9012": "Staff 3",
            "3456": "Manager"
        };

        let currentPIN = "";
        let currentStaffName = "";

        let inventory = JSON.parse(localStorage.getItem('posInventory')) || {
            "1001": { name: "SOMETHING MEATY PIZZA", price: 135, stock: 0, sold: 0 },
            "1002": { name: "HAWAIIAN PIZZA", price: 135, stock: 0, sold: 0 },
            "1003": { name: "FLAMING SPARE RIB PIZZA", price: 150, stock: 0, sold: 0 },
            "1004": { name: "CHEESE BURGER", price: 120, stock: 0, sold: 0 },
            "1005": { name: "CHEESY STRIPS (5)", price: 50, stock: 0, sold: 0 },
            "1006": { name: "BOERIE ROLL", price: 50, stock: 0, sold: 0 },
            "1007": { name: "RUMP STEAK", price: 160, stock: 0, sold: 0 },
            "1008": { name: "RIB RACK", price: 200, stock: 0, sold: 0 },
            "1009": { name: "SCHNITZEL", price: 120, stock: 0, sold: 0 },
            "1010": { name: "PREGO ROLL", price: 50, stock: 0, sold: 0 },
            "1011": { name: "MUNCHIE PLATTER", price: 350, stock: 0, sold: 0 },
            "1012": { name: "CHEESY POPS", price: 50, stock: 0, sold: 0 },
            "1013": { name: "CHICKEN PERI NACHO", price: 160, stock: 0, sold: 0 },
            "1014": { name: "WINGLETS 5", price: 60, stock: 0, sold: 0 },
            "1015": { name: "WINGLETS 10", price: 100, stock: 0, sold: 0 },
            "1016": { name: "PLATTER FOR 2", price: 350, stock: 0, sold: 0 },
            "1017": { name: "BREAKFAST", price: 80, stock: 0, sold: 0 },
            "1018": { name: "SIDE CHIPS", price: 20, stock: 0, sold: 0 },
            "1019": { name: "SIDE SALAD", price: 20, stock: 0, sold: 0 },
            "1020": { name: "GREEK SALAD", price: 20, stock: 0, sold: 0 },
            "2001": { name: "Coke 500ml", price: 15, stock: 0, sold: 0 },
            "5449000050809": { name: "Fanta Orange 500ml", price: 15, stock: 0, sold: 0 },
            "2003": { name: "Sprite 500ml", price: 15, stock: 0, sold: 0 },
            "2004": { name: "Powerade 500ml", price: 15, stock: 0, sold: 0 },
            "2005": { name: "Liquifruit 300ml", price: 15, stock: 0, sold: 0 },
            "2006": { name: "Appletizer 300ml", price: 15, stock: 0, sold: 0 },
            "2007": { name: "Mr Orange 300ml", price: 10, stock: 0, sold: 0 },
            "2008": { name: "Stoney 500ml", price: 15, stock: 0, sold: 0 },
            "2009": { name: "Tonic Water 200ml", price: 15, stock: 0, sold: 0 },
            "2010": { name: "Dry Lemon 200ml", price: 15, stock: 0, sold: 0 },
            "2011": { name: "Mineral Water 500ml", price: 10, stock: 0, sold: 0 },
            "2012": { name: "Sparkling Water 500ml", price: 15, stock: 0, sold: 0 },
            "2013": { name: "Mineral Water 1L", price: 15, stock: 0, sold: 0 },
            "2101": { name: "Black Label 500ml", price: 30, stock: 0, sold: 0 },
            "2102": { name: "Black Label 330ml", price: 30, stock: 0, sold: 0 },
            "2103": { name: "Castle Lager 330ml", price: 30, stock: 0, sold: 0 },
            "2104": { name: "Castle Light 330ml", price: 30, stock: 0, sold: 0 },
            "2105": { name: "Windhoek 500ml", price: 30, stock: 0, sold: 0 },
            "2201": { name: "Hunters Dry 330ml", price: 35, stock: 0, sold: 0 },
            "2202": { name: "Hunters Gold 330ml", price: 35, stock: 0, sold: 0 },
            "2203": { name: "Smirnoff Ice 440ml", price: 35, stock: 0, sold: 0 },
            "2204": { name: "Ruby Apple 275ml", price: 35, stock: 0, sold: 0 },
            "2205": { name: "Flying Fish 500ml", price: 35, stock: 0, sold: 0 },
            "2206": { name: "Savanna 330ml", price: 35, stock: 0, sold: 0 },
            "2207": { name: "Corona Extra 355ml", price: 35, stock: 0, sold: 0 },
            "2208": { name: "Extreme 330ml", price: 35, stock: 0, sold: 0 },
            "2209": { name: "Sodaze 250ml", price: 60, stock: 0, sold: 0 },
            "2210": { name: "Lucky Club 250ml", price: 70, stock: 0, sold: 0 }
        };

        function saveInventory() {
            localStorage.setItem('posInventory', JSON.stringify(inventory));
        }

        let cart = [];

        function login() {
            const pin = document.getElementById("pin").value.trim();
            if (STAFF[pin]) {
                currentPIN = pin;
                currentStaffName = STAFF[pin];
                document.getElementById("login").style.display = "none";
                document.getElementById("pos").style.display = "block";
                document.getElementById("barcode").focus();
            } else {
                alert("Invalid PIN");
            }
        }

        function stockInMode() {
            document.getElementById("login").style.display = "none";
            document.getElementById("stockIn").style.display = "block";
            document.getElementById("stockBarcode").focus();
        }

        function logout() {
            cart = [];
            updateCart();
            document.getElementById("pos").style.display = "none";
            document.getElementById("stockIn").style.display = "none";
            document.getElementById("inventoryView").style.display = "none";
            document.getElementById("login").style.display = "block";
            document.getElementById("pin").value = "";
            currentPIN = "";
            currentStaffName = "";
            stopScanner();
        }

        function showInventory() {
            document.getElementById("pos").style.display = "none";
            document.getElementById("inventoryView").style.display = "block";

            const list = document.getElementById("inventoryList");
            list.innerHTML = "";

            const sorted = Object.keys(inventory).map(code => ({
                code,
                ...inventory[code]
            })).sort((a, b) => a.name.localeCompare(b.name));

            sorted.forEach(item => {
                const li = document.createElement("li");
                let text = item.name + " — Stock: " + item.stock + " | Sold today: " + item.sold;
                if (item.stock >= 5) {
                    li.classList.add("in-stock");
                } else if (item.stock > 0) {
                    li.classList.add("low-stock-item");
                    text += " ⚠️ LOW STOCK";
                }
                li.textContent = text;
                list.appendChild(li);
            });
        }

        function backToPOS() {
            document.getElementById("inventoryView").style.display = "none";
            document.getElementById("pos").style.display = "block";
            document.getElementById("barcode").focus();
        }

        function addItem() {
            const code = document.getElementById("barcode").value.trim();
            if (!code) return;
            const item = inventory[code];
            if (!item) {
                alert("Item not found: " + code);
                document.getElementById("barcode").value = "";
                return;
            }
            if (item.stock <= 0) {
                alert("OUT OF STOCK: " + item.name);
                document.getElementById("barcode").value = "";
                return;
            }
            cart.push({ name: item.name, price: item.price, code: code });
            item.stock--;
            item.sold++;
            playEat();
            saveInventory();
            updateCart();
            updateStockStatus(item);
            document.getElementById("barcode").value = "";
            document.getElementById("barcode").focus();
        }

        document.getElementById("stockBarcode").addEventListener("change", () => {
            const code = document.getElementById("stockBarcode").value.trim();
            const item = inventory[code];
            if (item) {
                item.stock++;
                playSparkle();
                saveInventory();
                document.getElementById("stockInStatus").textContent = 
                    item.name + " added — Stock: " + item.stock + " | Sold today: " + item.sold;
            } else {
                alert("Unknown barcode");
            }
            document.getElementById("stockBarcode").value = "";
            document.getElementById("stockBarcode").focus();
        });

        function updateCart() {
            const list = document.getElementById("items");
            list.innerHTML = "";
            let total = 0;
            cart.forEach(it => {
                total += it.price;
                const li = document.createElement("li");
                li.textContent = it.name + " - R" + it.price.toFixed(2) + " (Stock left: " + inventory[it.code].stock + ")";
                list.appendChild(li);
            });
            document.getElementById("total").textContent = "Total: R" + total.toFixed(2);
        }

        function updateStockStatus(item) {
            let msg = item.name + " — Stock: " + item.stock + " | Sold today: " + item.sold;
            if (item.stock < 5) msg += " ⚠️ LOW STOCK - REORDER!";
            document.getElementById("stockStatus").textContent = msg;
        }

        function clearCart() {
            cart.forEach(it => {
                inventory[it.code].stock++;
                inventory[it.code].sold--;
            });
            saveInventory();
            cart = [];
            updateCart();
            document.getElementById("stockStatus").textContent = "";
        }

        function printReceipt() {
            if (cart.length === 0) return alert("Cart empty");

            let receipt = "PAPA RON'S COFFEE BAY\n";
            receipt += "============================\n";
            receipt += new Date().toLocaleString() + "\n";
            receipt += "Served by: " + currentStaffName + " (PIN: " + currentPIN + ")\n\n";

            let total = 0;
            cart.forEach(it => {
                receipt += it.name.padEnd(25) + "R" + it.price.toFixed(2) + "\n";
                total += it.price;
            });

            receipt += "============================\n";
            receipt += "TOTAL: ".padEnd(25) + "R" + total.toFixed(2) + "\n";
            receipt += "Thank you! Come again!\n\n\n";

            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            const doc = iframe.contentWindow.document;
            doc.open();
            doc.write('<pre style="font-family: monospace; font-size: 14pt;">' + receipt + '</pre>');
            doc.close();
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
            setTimeout(() => document.body.removeChild(iframe), 1000);
        }

        function payAndClear() {
            if (cart.length === 0) return alert("Cart empty");
            alert("Payment received! Thank you.");
            clearCart();
        }

        // Phone scanner
        let scannerActive = false;
        let scannerMode = "";

        function startPhoneScanner(mode) {
            scannerMode = mode;
            const video = mode === 'sale' ? document.getElementById("scannerVideo") : document.getElementById("scannerVideoStock");
            video.style.display = "block";

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(stream => {
                video.srcObject = stream;
                video.play();

                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: video
                    },
                    decoder: {
                        readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader"]
                    }
                }, err => {
                    if (err) { alert("Camera error: " + err); return; }
                    Quagga.start();
                });

                Quagga.onDetected(data => {
                    const code = data.codeResult.code;
                    if (mode === 'sale') {
                        document.getElementById("barcode").value = code;
                        addItem();
                    } else {
                        document.getElementById("stockBarcode").value = code;
                        document.getElementById("stockBarcode").dispatchEvent(new Event('change'));
                    }
                    stopScanner();
                });
            }).catch(err => alert("Camera access denied or not available"));
        }

        function stopScanner() {
            if (scannerActive) {
                Quagga.stop();
                const videos = document.querySelectorAll('video');
                videos.forEach(v => {
                    if (v.srcObject) {
                        v.srcObject.getTracks().forEach(track => track.stop());
                    }
                    v.style.display = "none";
                });
                scannerActive = false;
            }
        }

        // Enter key adds item
        document.getElementById("barcode").addEventListener("keyup", e => {
            if (e.key === "Enter") addItem();
        });

        // Load on start
        updateCart();
    </script>
</body>
</html>
