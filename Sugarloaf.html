<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PAPA RON'S PREMIUM POS</title>
    <style>
        :root {
            --primary: #d4a373;
            --bg: #000000;
            --surface: #121212;
            --surface-light: #1e1e1e;
            --accent: #44ff44;
            --danger: #ff4444;
            --warning: #ff9800;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); color: #fff; margin: 0; padding: 8px; overflow-x: hidden;
        }

        h1 { text-align: center; color: var(--primary); font-size: 1.4rem; letter-spacing: 2px; text-transform: uppercase; margin: 10px 0; font-weight: 900; }
        h3 { color: var(--primary); margin: 0; font-weight: 800; text-transform: uppercase; font-size: 0.9rem; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px; }

        input, button, select { 
            font-size: 0.9rem; padding: 12px; margin: 4px 0; width: 100%; border-radius: 6px; box-sizing: border-box; border: 1px solid #333; font-weight: 800;
        }

        button { background: var(--primary); color: #000; border: none; cursor: pointer; text-transform: uppercase; font-weight: 900; }
        button:active { transform: scale(0.96); opacity: 0.8; }
        
        .grid-main { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .tab-content { display: none; margin-top: 10px; }
        .active-tab { display: block; }
        
        .category-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(95px, 1fr)); 
            gap: 8px; background: var(--surface); padding: 8px; border-radius: 10px; border: 1px solid #222;
        }

        .product-btn { 
            position: relative; min-height: 70px; font-size: 0.75rem; color: white; border: none; 
            display: flex; align-items: center; justify-content: center; text-align: center; 
            border-radius: 6px; font-weight: 900; padding: 6px; cursor: pointer; text-transform: uppercase;
        }

        .food-btn { background: linear-gradient(145deg, #3d2b1f, #2a1d15); border-bottom: 3px solid #5d4037; }
        .drink-btn { background: linear-gradient(145deg, #0d47a1, #0a2e66); border-bottom: 3px solid #1565c0; }
        
        .btn-del-x { 
            position: absolute; top: -6px; right: -6px; background: var(--danger); color: white; 
            border-radius: 50%; width: 22px; height: 22px; font-size: 11px; line-height: 22px; 
            text-align: center; z-index: 10; border: 1px solid #fff; 
        }

        #trans-tabs { display: flex; gap: 5px; overflow-x: auto; padding: 5px 0; }
        .tab-btn { width: auto; padding: 10px 18px; background: #222; color: #777; white-space: nowrap; border: 1px solid #333; font-size: 0.85rem; }
        .tab-btn.active { background: var(--primary); color: #000; border-color: #fff; }

        #cart-list { background: var(--surface); border-radius: 8px; padding: 10px; margin: 10px 0; max-height: 200px; overflow-y: auto; border: 1px solid #222; }
        .cart-row { display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding: 8px 0; align-items: center; font-size: 0.9rem; font-weight: 700; }
        #total-view { font-size: 2.8rem; color: var(--accent); text-align: center; margin: 10px 0; font-family: monospace; font-weight: 900; }

        .stock-row { display: grid; grid-template-columns: 40px 1.5fr 0.8fr 0.8fr 100px; align-items: center; background: var(--surface); margin-bottom: 5px; padding: 8px; border-radius: 8px; gap: 5px; border: 1px solid #222; font-size: 0.85rem; text-align: center; font-weight: 700; }
        .stock-check { width: 20px; height: 20px; cursor: pointer; }
        .stock-status-low { color: var(--danger); font-weight: 900; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #111; padding: 25px; border-radius: 12px; width: 85%; max-width: 380px; z-index: 1000; border: 2px solid var(--primary); display: none; }
        .stock-footer { background: var(--surface-light); padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px dashed var(--primary); text-align: center; font-weight: 800; }
        .distro-box { background: var(--surface-light); border: 2px solid var(--warning); padding: 15px; border-radius: 10px; margin-top: 20px; }
        .ing-grid { display: grid; grid-template-columns: 1.5fr 0.8fr 0.8fr; gap: 5px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <h1>Papa Ron's POS</h1>

    <div class="grid-main">
        <button onclick="switchTab('pos-tab')">Sales Terminal</button>
        <button onclick="switchTab('menu-tab')">Product Builder</button>
        <button onclick="switchTab('stock-tab')">Stock Manager</button>
        <button onclick="switchTab('report-tab')" style="background:#222; color:#fff;">Financials</button>
    </div>

    <div id="pos-tab" class="tab-content active-tab">
        <div id="trans-tabs"></div>
        <button onclick="createNewTransaction()" style="background:var(--accent); color:#000; height: 50px; margin-bottom: 10px;">+ NEW TABLE</button>
        <div class="grid-main">
            <div>
                <h3>Food</h3>
                <div class="category-grid" id="foodGrid"></div>
            </div>
            <div>
                <h3>Drinks</h3>
                <div class="category-grid" id="drinkGrid"></div>
            </div>
        </div>
        <div id="cart-list"></div>
        <div id="total-view">R 0.00</div>
        <div class="grid-main">
            <button onclick="openTender()" style="background:#2e7d32; color:#fff; height:75px; font-size: 1.5rem;">CASH</button>
            <button onclick="finalizeSale('Card')" style="background:#1565c0; color:#fff; height:75px; font-size: 1.5rem;">CARD</button>
            <button onclick="printKitchenSlip()" style="background:#444; color:#fff;">Kitchen Slip</button>
            <button onclick="deleteCurrentTransaction()" style="background:transparent; border:1px solid var(--danger); color:var(--danger);">Void</button>
        </div>
    </div>

    <div id="menu-tab" class="tab-content">
        <div style="background:var(--surface); padding:20px; border-radius:12px; border:1px solid #333;">
            <h3>Create New Product</h3>
            <input type="text" id="m-name" placeholder="ITEM NAME (e.g. Classic Burger)">
            <div class="grid-main">
                <input type="number" id="m-price" placeholder="Sell Price (R)">
                <input type="number" id="m-cost" placeholder="Direct Cost (R)">
            </div>
            <select id="m-cat"><option value="food">Category: Food</option><option value="drink">Category: Drink</option></select>
            
            <p style="font-size: 0.8rem; color: var(--primary); margin: 15px 0 5px 0; font-weight: 900;">RECIPE / INGREDIENTS</p>
            <div id="ing-rows">
                <div class="ing-grid">
                    <input type="text" class="i-name" placeholder="Ingredient">
                    <input type="number" class="i-qty" placeholder="Qty">
                    <input type="number" class="i-cost" placeholder="Cost">
                </div>
            </div>
            <button onclick="addIngRow()" style="background:#333; color:#fff; width: auto; padding: 8px 15px; margin-top: 10px;">+ Add Line</button>
            <button onclick="saveNewProduct()" style="background:var(--accent); color:#000; margin-top:20px; height: 55px;">SAVE PRODUCT</button>
        </div>
    </div>

    <div id="stock-tab" class="tab-content">
        <div style="background:var(--surface); padding:10px; border-radius:10px; margin-bottom:15px;">
            <div style="display:flex; gap:10px;">
                <button onclick="printSelectedStock()" style="background:#fff; color:#000;">Print Order List</button>
                <button onclick="selectAll(true)" style="width: auto; padding: 5px 15px;">All</button>
                <button onclick="selectAll(false)" style="width: auto; padding: 5px 15px;">None</button>
            </div>
            <button onclick="printFullValuationReport()" style="background:var(--primary); color:#000; margin-top:10px;">PRINT STOCK VALUATION REPORT</button>
        </div>
        <div style="display: grid; grid-template-columns: 40px 1.5fr 0.8fr 0.8fr 100px; padding: 5px; font-weight: 900; color: var(--primary); font-size: 0.7rem; text-align: center;">
            <span>PICK</span><span>ITEM NAME</span><span>STOCK</span><span>GP</span><span>ACTION</span>
        </div>
        <div id="inventory-display"></div>
        <div class="stock-footer" id="stock-summary"></div>

        <div class="distro-box">
            <h3>Branch Stock Transfer</h3>
            <input type="text" id="distro-to" placeholder="DESTINATION BRANCH">
            <input type="number" id="distro-amt" placeholder="QUANTITY PER ITEM">
            <button onclick="processDistro()" style="background:var(--warning); color:#000; margin-top:10px; height:50px;">PROCESS TRANSFER</button>
        </div>
    </div>

    <div id="report-tab" class="tab-content">
        <div style="background:var(--surface); padding:20px; border-radius:12px;">
            <h3>Financial Performance</h3>
            <button onclick="generateReport('daily')" style="margin-bottom:10px;">Generate Daily Z-Report</button>
            <button onclick="generateReport('weekly')" style="margin-bottom:10px;">Weekly Sales Summary</button>
            <button onclick="generateReport('monthly')">Monthly Profit/Loss</button>
        </div>
    </div>

    <div id="stock-modal" class="modal">
        <h2 id="stock-item-name" style="text-align:center; color:var(--primary);"></h2>
        <input type="number" id="stock-add-amt" placeholder="Qty to Add">
        <button onclick="confirmStockAdd()" style="height:55px;">UPDATE STOCK</button>
        <button onclick="closeModal()" style="background:#333; color:#fff; margin-top:10px;">CANCEL</button>
    </div>

    <div id="tender-modal" class="modal">
        <h1 id="cash-total-needed" style="text-align:center; color:var(--accent);"></h1>
        <input type="number" id="cash-amt" placeholder="Cash Received" oninput="calculateChange()" style="font-size: 2rem; text-align:center;">
        <h2 id="change-due" style="text-align:center;">Change: R0.00</h2>
        <button onclick="finalizeSale('Cash')" style="height:60px;">COMPLETE SALE</button>
        <button onclick="closeModal()" style="background:#333; color:#fff; margin-top:10px;">BACK</button>
    </div>

    <script>
        let inventory = JSON.parse(localStorage.getItem('pos_inv')) || {};
        let recipes = JSON.parse(localStorage.getItem('pos_rec')) || {};
        let transactions = JSON.parse(localStorage.getItem('pos_trans')) || [];
        
        if (transactions.filter(t => t.status === 'active').length === 0) createNewTransaction();
        let currentTransIdx = transactions.findIndex(t => t.status === 'active');
        let selectedStockKey = "";

        function persist() {
            localStorage.setItem('pos_inv', JSON.stringify(inventory));
            localStorage.setItem('pos_rec', JSON.stringify(recipes));
            localStorage.setItem('pos_trans', JSON.stringify(transactions));
            updateValuation();
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
            document.getElementById(id).classList.add('active-tab');
            if(id === 'pos-tab') renderPOS();
            if(id === 'stock-tab') renderStock();
        }

        function updateValuation() {
            let costVal = 0; let retailVal = 0;
            Object.values(inventory).forEach(itm => {
                if(itm.stock > 0) {
                    costVal += (itm.stock * (itm.cost || 0));
                    retailVal += (itm.stock * (itm.price || 0));
                }
            });
            const summary = document.getElementById('stock-summary');
            if(summary) summary.innerHTML = `VALUE (COST): R${costVal.toFixed(2)} | PROFIT POTENTIAL: R${(retailVal - costVal).toFixed(2)}`;
            return { costVal, retailVal };
        }

        function renderPOS() {
            const f = document.getElementById('foodGrid'); const d = document.getElementById('drinkGrid');
            f.innerHTML = ''; d.innerHTML = '';
            Object.keys(inventory).forEach(key => {
                if(inventory[key].category === 'ingredient') return;
                const btn = document.createElement('div');
                btn.className = `product-btn ${inventory[key].category}-btn`;
                btn.innerHTML = `<div class="btn-del-x" onclick="deleteMenuBtn(event, '${key}')">X</div>
                                 <div style="width:100%" onclick="addToCart('${key}')"><b>${inventory[key].name}</b><br>R${inventory[key].price.toFixed(2)}</div>`;
                inventory[key].category === 'food' ? f.appendChild(btn) : d.appendChild(btn);
            });
            const tTabs = document.getElementById('trans-tabs'); tTabs.innerHTML = '';
            transactions.forEach((t, i) => {
                if(t.status !== 'active') return;
                const btn = document.createElement('button');
                btn.className = `tab-btn ${i === currentTransIdx ? 'active' : ''}`;
                btn.textContent = `Table ${t.id}`;
                btn.onclick = () => { currentTransIdx = i; renderPOS(); };
                tTabs.appendChild(btn);
            });
            updateCartUI();
        }

        function addToCart(key) {
            transactions[currentTransIdx].items.push({...inventory[key], code: key});
            persist(); updateCartUI();
        }

        function updateCartUI() {
            const list = document.getElementById('cart-list'); list.innerHTML = '';
            let total = 0;
            if(transactions[currentTransIdx]) {
                transactions[currentTransIdx].items.forEach((it, i) => {
                    total += it.price;
                    list.innerHTML += `<div class="cart-row"><span>${it.name}</span><span>R${it.price.toFixed(2)} <button onclick="removeFromCart(${i})" style="background:var(--danger); border:none; color:white; padding:2px 8px; border-radius:4px;">×</button></span></div>`;
                });
            }
            document.getElementById('total-view').textContent = `R ${total.toFixed(2)}`;
        }

        function removeFromCart(i) { transactions[currentTransIdx].items.splice(i, 1); persist(); updateCartUI(); }

        function renderStock() {
            const cont = document.getElementById('inventory-display'); cont.innerHTML = '';
            Object.keys(inventory).sort().forEach(key => {
                const itm = inventory[key];
                const profit = (itm.price || 0) - (itm.cost || 0);
                cont.innerHTML += `
                    <div class="stock-row">
                        <input type="checkbox" class="stock-check" value="${key}">
                        <div style="text-align:left;"><b>${itm.name}</b></div>
                        <div class="${itm.stock <= 5 ? 'stock-status-low' : ''}">${itm.stock.toFixed(1)}</div>
                        <div style="color:#777;">R${profit.toFixed(2)}</div>
                        <div style="display:flex; gap:3px;">
                            <button onclick="openStockIn('${key}')" style="background:var(--accent); color:#000; font-size:0.7rem; padding:5px;">+In</button>
                            <button onclick="deleteStockItem('${key}')" style="background:var(--danger); color:#fff; font-size:0.7rem; padding:5px;">×</button>
                        </div>
                    </div>`;
            });
            updateValuation();
        }

        function finalizeSale(method) {
            const t = transactions[currentTransIdx];
            if (!t || t.items.length === 0) return;
            t.total = t.items.reduce((s, i) => s + i.price, 0);
            t.method = method; t.status = 'paid'; t.date = new Date().getTime();
            t.items.forEach(it => {
                if(inventory[it.code]) inventory[it.code].stock--; 
                if(recipes[it.code]) { for(let ing in recipes[it.code]) if(inventory[ing]) inventory[ing].stock -= recipes[it.code][ing]; }
            });
            printSlip(t); persist(); createNewTransaction(); closeModal();
        }

        function printSlip(t) {
            const win = window.open('', '', 'width=300,height=600');
            let items = t.items.map(i => `${i.name.padEnd(15)} R${i.price.toFixed(2)}`).join('\n');
            win.document.write(`<pre style="font-family:monospace; font-size:10pt;">   PAPA RON'S\n----------------\nTable: ${t.id}\nDate: ${new Date(t.date).toLocaleString()}\n----------------\n${items}\n----------------\nTOTAL: R${t.total.toFixed(2)}\nMETHOD: ${t.method}\n\nTHANK YOU!</pre>`);
            win.document.close(); win.print();
        }

        function printKitchenSlip() {
            const t = transactions[currentTransIdx];
            if(!t || t.items.length === 0) return;
            const win = window.open('', '', 'width=300,height=400');
            let items = t.items.map(i => `[ ] ${i.name}`).join('\n');
            win.document.write(`<pre style="font-family:monospace; font-size:14pt; font-weight:bold;">KITCHEN ORDER\nTable: ${t.id}\n----------------\n${items}</pre>`);
            win.document.close(); win.print();
        }

        function saveNewProduct() {
            const name = document.getElementById('m-name').value.toUpperCase();
            const price = parseFloat(document.getElementById('m-price').value);
            const cost = parseFloat(document.getElementById('m-cost').value) || 0;
            const cat = document.getElementById('m-cat').value;
            if(!name || isNaN(price)) return alert("Missing Info");
            const id = "P_" + Date.now();
            let recipe = {};
            const names = document.querySelectorAll('.i-name'), qtys = document.querySelectorAll('.i-qty'), costs = document.querySelectorAll('.i-cost');
            names.forEach((n, i) => {
                const iname = n.value.toUpperCase(), iqty = parseFloat(qtys[i].value), icost = parseFloat(costs[i].value) || 0;
                if(iname && iqty) { 
                    recipe[iname] = iqty; 
                    if(!inventory[iname]) inventory[iname] = { name: iname, stock: 0, cost: icost, category: 'ingredient' }; 
                }
            });
            inventory[id] = { name, price, cost, category: cat, stock: 0 };
            if(Object.keys(recipe).length > 0) recipes[id] = recipe;
            persist(); location.reload();
        }

        function createNewTransaction() {
            transactions.push({id: transactions.length + 1, items: [], status:'active', date: new Date().getTime()});
            currentTransIdx = transactions.length - 1;
            if(document.getElementById('pos-tab').classList.contains('active-tab')) renderPOS();
        }

        function generateReport(range) {
            const now = new Date(); let start = 0;
            if(range === 'daily') start = new Date(now.setHours(0,0,0,0)).getTime();
            if(range === 'weekly') start = now.getTime() - (7 * 86400000);
            if(range === 'monthly') start = now.getTime() - (30 * 86400000);
            const sales = transactions.filter(t => t.status === 'paid' && t.date >= start);
            let total = 0; let cost = 0;
            let report = `${range.toUpperCase()} REPORT\n----------------\n`;
            sales.forEach(s => { report += `T${s.id}: R${s.total.toFixed(2)}\n`; total += s.total; s.items.forEach(i => cost += (i.cost || 0)); });
            report += `----------------\nSALES: R${total.toFixed(2)}\nPROFIT: R${(total - cost).toFixed(2)}`;
            const win = window.open('', '', 'width=350,height=500');
            win.document.write(`<pre style="font-family:monospace;">${report}</pre>`);
            win.document.close(); win.print();
        }

        function processDistro() {
            const dest = document.getElementById('distro-to').value.toUpperCase();
            const qty = parseFloat(document.getElementById('distro-amt').value);
            const checked = document.querySelectorAll('.stock-check:checked');
            if(!dest || isNaN(qty) || checked.length === 0) return alert("Error");
            let slip = `TRANSFER TO: ${dest}\n----------------\n`;
            checked.forEach(cb => { const itm = inventory[cb.value]; itm.stock -= qty; slip += `${qty} x ${itm.name}\n`; });
            persist(); renderStock();
            const win = window.open('', '', 'width=300,height=400');
            win.document.write(`<pre style="font-family:monospace;">${slip}</pre>`);
            win.document.close(); win.print();
        }

        function printFullValuationReport() {
            const data = updateValuation();
            let win = window.open('', '', 'width=800,height=900');
            let rows = Object.keys(inventory).sort().map(k => {
                let i = inventory[k];
                return `<tr><td>${i.name}</td><td>${i.stock.toFixed(1)}</td><td>R${(i.cost||0).toFixed(2)}</td><td>R${(i.stock * (i.cost||0)).toFixed(2)}</td></tr>`;
            }).join('');
            win.document.write(`<html><body><h1>Valuation Report</h1><table border="1" style="width:100%; border-collapse:collapse;"><tr><th>Item</th><th>Stock</th><th>Cost</th><th>Total</th></tr>${rows}</table><h3>Total Cost: R${data.costVal.toFixed(2)}</h3></body></html>`);
            win.document.close(); win.print();
        }

        function addIngRow() {
            const div = document.createElement('div'); div.className = "ing-grid";
            div.innerHTML = `<input type="text" class="i-name" placeholder="Ingredient"><input type="number" class="i-qty" placeholder="Qty"><input type="number" class="i-cost" placeholder="Cost">`;
            document.getElementById('ing-rows').appendChild(div);
        }

        function openTender() {
            const total = transactions[currentTransIdx].items.reduce((s, i) => s + i.price, 0);
            if(total === 0) return;
            document.getElementById('cash-total-needed').textContent = `R${total.toFixed(2)}`;
            document.getElementById('tender-modal').style.display = 'block';
        }

        function calculateChange() {
            const total = transactions[currentTransIdx].items.reduce((s, i) => s + i.price, 0);
            const cash = parseFloat(document.getElementById('cash-amt').value) || 0;
            document.getElementById('change-due').textContent = `Change: R${(cash - total).toFixed(2)}`;
        }

        function openStockIn(k) { selectedStockKey = k; document.getElementById('stock-item-name').textContent = inventory[k].name; document.getElementById('stock-modal').style.display = 'block'; }
        function confirmStockAdd() { const a = parseFloat(document.getElementById('stock-add-amt').value); if(a) { inventory[selectedStockKey].stock += a; persist(); renderStock(); closeModal(); } }
        function selectAll(v) { document.querySelectorAll('.stock-check').forEach(c => c.checked = v); }
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
        function deleteMenuBtn(e, k) { e.stopPropagation(); if(confirm("Delete?")) { delete inventory[k]; persist(); renderPOS(); } }
        function deleteStockItem(k) { if(confirm("Delete Stock?")) { delete inventory[k]; persist(); renderStock(); } }
        function deleteCurrentTransaction() { if(confirm("Void?")) { transactions.splice(currentTransIdx, 1); if(transactions.filter(t=>t.status==='active').length===0) createNewTransaction(); else currentTransIdx = 0; persist(); renderPOS(); } }

        window.onload = () => { renderPOS(); renderStock(); };
    </script>
</body>
</html>
