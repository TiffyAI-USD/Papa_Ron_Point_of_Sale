<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PAPA RON'S PREMIUM POS</title>
    <style>
        :root {
            --primary: #d4a373;
            --gold-grad: linear-gradient(145deg, #d4a373, #b38b59);
            --bg: #000000;
            --surface: #121212;
            --surface-light: #1e1e1e;
            --accent: #44ff44;
            --danger: #ff4444;
            --warning: #ff9800;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 8px; overflow-x: hidden; }
        h1 { text-align: center; color: var(--primary); font-size: 1.4rem; letter-spacing: 2px; text-transform: uppercase; margin: 10px 0; font-weight: 900; }
        h3 { color: var(--primary); margin: 0; font-weight: 800; text-transform: uppercase; font-size: 0.9rem; }

        input, button, select { font-size: 0.9rem; padding: 12px; margin: 4px 0; width: 100%; border-radius: 6px; box-sizing: border-box; border: 1px solid #333; font-weight: 800; }
        
        button, .product-btn { background: var(--gold-grad) !important; color: #000 !important; border: none; cursor: pointer; text-transform: uppercase; font-weight: 900; }
        button:active { transform: scale(0.96); opacity: 0.8; }
        
        .grid-main { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .tab-content { display: none; margin-top: 10px; }
        .active-tab { display: block; }
        
        .category-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 6px; background: var(--surface); padding: 8px; border-radius: 10px; border: 1px solid #222; }

        .product-btn { position: relative; min-height: 65px; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; text-align: center; border-radius: 6px; padding: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        
        .btn-del-x { position: absolute; top: -6px; right: -6px; background: var(--danger) !important; color: white !important; border-radius: 50%; width: 22px; height: 22px; font-size: 11px; line-height: 22px; text-align: center; border: 1px solid #fff; }

        #trans-tabs { display: flex; gap: 4px; overflow-x: auto; padding: 4px 0; }
        .tab-btn { width: auto; padding: 8px 16px; background: #222 !important; color: #777 !important; border: 1px solid #333; }
        .tab-btn.active { background: var(--gold-grad) !important; color: #000 !important; }

        #cart-list { background: var(--surface); border-radius: 8px; padding: 8px; margin: 8px 0; max-height: 150px; overflow-y: auto; border: 1px solid #222; }
        .cart-row { display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding: 6px 0; align-items: center; font-size: 0.85rem; font-weight: 700; }
        #total-view { font-size: 2.5rem; color: var(--accent); text-align: center; margin: 5px 0; font-family: monospace; font-weight: 900; }

        .stock-row { display: grid; grid-template-columns: 35px 1.5fr 0.8fr 0.8fr 100px; align-items: center; background: var(--surface); margin-bottom: 4px; padding: 6px; border-radius: 6px; gap: 4px; border: 1px solid #222; font-size: 0.8rem; text-align: center; font-weight: 700; }
        
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #111; padding: 20px; border-radius: 12px; width: 85%; max-width: 350px; z-index: 1000; border: 2px solid var(--primary); display: none; }
        .manager-only { display: none; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>PAPA RON'S</h1>
        <input type="password" id="pin-input" inputmode="numeric" placeholder="ENTER PIN" style="text-align: center; width: 220px; font-size: 1.5rem; letter-spacing: 5px;">
        <button onclick="handleLogin()" style="width: 220px; height: 50px; margin-top: 10px;">Login</button>
    </div>

    <h1>Papa Ron's</h1>

    <div class="grid-main">
        <button onclick="switchTab('pos-tab')">Sales</button>
        <button class="manager-only" onclick="switchTab('menu-tab')">Builder</button>
        <button onclick="switchTab('stock-tab')">Stock</button>
        <button onclick="switchTab('report-tab')" style="background:#222 !important; color:#fff !important;">Reports</button>
    </div>

    <div id="pos-tab" class="tab-content active-tab">
        <div id="trans-tabs"></div>
        <button onclick="createNewTransaction()" style="background:var(--accent) !important; color:#000 !important;">+ NEW TABLE</button>
        <div class="grid-main">
            <div class="category-grid" id="foodGrid"></div>
            <div class="category-grid" id="drinkGrid"></div>
        </div>
        <div id="cart-list"></div>
        <div id="total-view">R 0.00</div>
        <div class="grid-main">
            <button onclick="openTender()" style="background:#2e7d32 !important; color:#fff !important; height:60px;">CASH</button>
            <button onclick="finalizeSale('Card')" style="background:#1565c0 !important; color:#fff !important; height:60px;">CARD</button>
            <button onclick="printKitchenSlip()" style="background:#444 !important; color:#fff !important;">Kitchen Slip</button>
            <button class="manager-only" onclick="deleteCurrentTransaction()" style="background:transparent !important; border:1px solid var(--danger); color:var(--danger) !important;">Void Table</button>
            <button onclick="logout()" style="background:#222 !important; color:#fff !important;">Logout</button>
        </div>
    </div>

    <div id="menu-tab" class="tab-content manager-only">
        <div style="background:var(--surface); padding:15px; border-radius:10px;">
            <h3>Product Builder</h3>
            <input type="text" id="m-name" placeholder="ITEM NAME">
            <div class="grid-main">
                <input type="number" id="m-price" placeholder="Sell Price">
                <input type="number" id="m-cost" placeholder="Direct Cost">
            </div>
            <select id="m-cat"><option value="food">Food</option><option value="drink">Drink</option></select>
            <div id="ing-rows"><div class="ing-grid"><input type="text" class="i-name" placeholder="Ingredient"><input type="number" class="i-qty" placeholder="Qty"></div></div>
            <button onclick="addIngRow()" class="btn-small" style="background:#333 !important; color:#fff !important; margin: 10px 0;">+ Add Ingredient</button>
            <button onclick="saveNewProduct()">SAVE PRODUCT</button>
        </div>
    </div>

    <div id="stock-tab" class="tab-content">
        <div id="inventory-display"></div>
        <div id="stock-summary" class="manager-only" style="background:var(--surface-light); padding:10px; margin-top:10px; border-radius:8px; text-align:center;"></div>
    </div>

    <div id="report-tab" class="tab-content">
        <div style="background:var(--surface); padding:15px; border-radius:10px;">
            <h3 id="report-title">Waitress Cash Up</h3>
            <p style="font-size:0.7rem; color:var(--primary);">WAITER CODE: <span id="current-user-display"></span></p>
            <button onclick="generateReport('daily', false)" style="margin-bottom:8px;">My Daily Cash Up</button>
            <button onclick="generateReport('weekly', false)" style="margin-bottom:8px;">My Weekly Report</button>
            
            <div class="manager-only" style="border-top: 1px solid #444; margin-top: 15px; padding-top: 15px;">
                <h3 style="color:var(--accent);">Manager Totals</h3>
                <button onclick="generateReport('daily', true)" style="margin-bottom:8px; background:var(--accent) !important;">Store Daily Total</button>
                <button onclick="generateReport('weekly', true)" style="margin-bottom:8px;">Store Weekly Total</button>
                <button onclick="generateReport('monthly', true)">Store Monthly Total</button>
            </div>
        </div>
    </div>

    <div id="stock-modal" class="modal">
        <h2 id="stock-item-name" style="text-align:center; color:var(--primary);"></h2>
        <input type="number" id="stock-add-amt" placeholder="Qty to Add">
        <button onclick="confirmStockAdd()">Update Stock</button>
        <button onclick="closeModal()" style="background:#333 !important; color:#fff !important; margin-top:8px;">Cancel</button>
    </div>

    <div id="tender-modal" class="modal">
        <h1 id="cash-total-needed" style="text-align:center; color:var(--accent);"></h1>
        <input type="number" id="cash-amt" placeholder="Amount Received" oninput="calculateChange()">
        <h2 id="change-due" style="text-align:center;">Change: R0.00</h2>
        <button onclick="finalizeSale('Cash')">Complete Sale</button>
        <button onclick="closeModal()" style="background:#333 !important; color:#fff !important; margin-top:8px;">Back</button>
    </div>

    <script>
        const MANAGER_PIN = "1234";
        const STAFF_PINS = ["1111", "2222", "3333", "4444", "5555"];
        let isManager = false;
        let currentUser = "";

        let inventory = JSON.parse(localStorage.getItem('pos_inv')) || {};
        let recipes = JSON.parse(localStorage.getItem('pos_rec')) || {};
        let transactions = JSON.parse(localStorage.getItem('pos_trans')) || [];
        
        if (transactions.filter(t => t.status === 'active').length === 0) { createNewTransaction(); }
        let currentTransIdx = transactions.findIndex(t => t.status === 'active');

        function handleLogin() {
            const pin = document.getElementById('pin-input').value;
            if (pin === MANAGER_PIN) { isManager = true; currentUser = "MANAGER"; initApp(); }
            else if (STAFF_PINS.includes(pin)) { isManager = false; currentUser = pin; initApp(); }
            else { alert("Invalid PIN"); }
        }

        function initApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('current-user-display').textContent = currentUser;
            document.querySelectorAll('.manager-only').forEach(e => e.style.display = isManager ? 'block' : 'none');
            renderPOS();
        }

        function logout() { location.reload(); }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
            document.getElementById(id).classList.add('active-tab');
            if(id === 'pos-tab') renderPOS();
            if(id === 'stock-tab') renderStock();
        }

        function renderPOS() {
            const f = document.getElementById('foodGrid'); const d = document.getElementById('drinkGrid');
            f.innerHTML = ''; d.innerHTML = '';
            Object.keys(inventory).forEach(key => {
                if(inventory[key].category === 'ingredient') return;
                const btn = document.createElement('div');
                btn.className = `product-btn`;
                btn.innerHTML = `${isManager ? `<div class="btn-del-x" onclick="deleteMenuBtn(event, '${key}')">X</div>` : ''}
                                 <div style="width:100%" onclick="addToCart('${key}')"><b>${inventory[key].name}</b><br>R${inventory[key].price.toFixed(2)}</div>`;
                inventory[key].category === 'food' ? f.appendChild(btn) : d.appendChild(btn);
            });
            renderTabs(); updateCartUI();
        }

        function renderTabs() {
            const tTabs = document.getElementById('trans-tabs'); tTabs.innerHTML = '';
            transactions.forEach((t, i) => {
                if(t.status !== 'active') return;
                const btn = document.createElement('button');
                btn.className = `tab-btn ${i === currentTransIdx ? 'active' : ''}`;
                btn.textContent = `Table ${t.id}`;
                btn.onclick = () => { currentTransIdx = i; renderPOS(); };
                tTabs.appendChild(btn);
            });
        }

        function addToCart(key) {
            transactions[currentTransIdx].items.push({...inventory[key], code: key});
            save(); updateCartUI();
        }

        function updateCartUI() {
            const list = document.getElementById('cart-list'); list.innerHTML = ''; let total = 0;
            if(transactions[currentTransIdx]) {
                transactions[currentTransIdx].items.forEach((it, i) => {
                    total += it.price;
                    list.innerHTML += `<div class="cart-row"><span>${it.name}</span><span>R${it.price.toFixed(2)} ${isManager ? `<button onclick="removeFromCart(${i})" style="background:var(--danger) !important; color:white !important; width:20px; padding:2px;">×</button>` : ''}</span></div>`;
                });
            }
            document.getElementById('total-view').textContent = `R ${total.toFixed(2)}`;
        }

        function removeFromCart(i) { if(isManager) { transactions[currentTransIdx].items.splice(i, 1); save(); updateCartUI(); } }

        function finalizeSale(method) {
            const t = transactions[currentTransIdx]; if (!t || t.items.length === 0) return;
            t.total = t.items.reduce((s, i) => s + i.price, 0);
            t.method = method; t.status = 'paid'; t.date = new Date().getTime(); t.waiter = currentUser;
            t.items.forEach(it => {
                if(inventory[it.code]) inventory[it.code].stock--;
                if(recipes[it.code]) { for(let ing in recipes[it.code]) if(inventory[ing]) inventory[ing].stock -= recipes[it.code][ing]; }
            });
            printReceipt(t); save(); createNewTransaction(); closeModal();
        }

        function generateReport(range, isFullStore) {
            const now = new Date(); let startTime = 0;
            if(range === 'daily') startTime = new Date(now.setHours(0,0,0,0)).getTime();
            if(range === 'weekly') startTime = now.getTime() - (7 * 24 * 60 * 60 * 1000);
            if(range === 'monthly') startTime = now.getTime() - (30 * 24 * 60 * 60 * 1000);
            
            let filtered = transactions.filter(t => t.status === 'paid' && t.date >= startTime);
            if(!isFullStore) { filtered = filtered.filter(t => t.waiter === currentUser); }

            let total = 0;
            let output = `PAPA RON'S ${range.toUpperCase()} REPORT\n`;
            output += `TYPE: ${isFullStore ? 'FULL STORE' : 'STAFF: ' + currentUser}\n`;
            output += `DATE: ${new Date().toLocaleDateString()}\n--------------------------\n`;
            
            filtered.forEach(s => { 
                output += `T${s.id} | R${s.total.toFixed(2)} | ${s.method} ${isFullStore ? '['+s.waiter+']' : ''}\n`; 
                total += s.total; 
            });

            output += `--------------------------\nGRAND TOTAL: R${total.toFixed(2)}\n--------------------------`;
            
            printToWindow(output);
        }

        function printToWindow(content) {
            const win = window.open('', '_blank', 'width=400,height=600');
            win.document.write(`<html><body style="margin:0;padding:20px;"><pre style="font-family:monospace; font-size:12pt; white-space: pre-wrap;">${content}</pre></body></html>`);
            win.document.close();
            win.setTimeout(() => { win.print(); win.close(); }, 500);
        }

        function printReceipt(t) {
            let items = t.items.map(i => `${i.name.padEnd(15)} R${i.price.toFixed(2)}`).join('\n');
            let content = `PAPA RON'S\nWaiter: ${t.waiter}\nTable: ${t.id}\nDate: ${new Date(t.date).toLocaleString()}\n--------------------------\n${items}\n--------------------------\nTOTAL: R${t.total.toFixed(2)}\nMETHOD: ${t.method}\n--------------------------\nTHANK YOU`;
            printToWindow(content);
        }

        function printKitchenSlip() {
            const t = transactions[currentTransIdx];
            if(!t || t.items.length === 0) return;
            let items = t.items.map(i => `[ ] ${i.name}`).join('\n');
            let content = `KITCHEN ORDER\nTable: ${t.id}\nWaiter: ${currentUser}\n--------------------------\n${items}\n--------------------------`;
            printToWindow(content);
        }

        function renderStock() {
            const cont = document.getElementById('inventory-display'); cont.innerHTML = '';
            Object.keys(inventory).sort().forEach(key => {
                const itm = inventory[key];
                cont.innerHTML += `<div class="stock-row"><span>•</span><div style="text-align:left;"><b>${itm.name}</b></div><div style="color:var(--accent)">${itm.stock.toFixed(1)}</div><div style="color:#777;">R${((itm.price||0)-(itm.cost||0)).toFixed(2)}</div><div><button onclick="openStockIn('${key}')" class="btn-small">+In</button></div></div>`;
            });
        }

        function save() { localStorage.setItem('pos_inv', JSON.stringify(inventory)); localStorage.setItem('pos_rec', JSON.stringify(recipes)); localStorage.setItem('pos_trans', JSON.stringify(transactions)); }
        function createNewTransaction() { transactions.push({id: transactions.length + 1, items: [], status:'active', date: new Date().getTime()}); currentTransIdx = transactions.length - 1; renderPOS(); }
        function openTender() { const total = transactions[currentTransIdx].items.reduce((s, i) => s + i.price, 0); document.getElementById('cash-total-needed').textContent = `R${total.toFixed(2)}`; document.getElementById('tender-modal').style.display = 'block'; }
        function calculateChange() { const total = transactions[currentTransIdx].items.reduce((s, i) => s + i.price, 0); const cash = parseFloat(document.getElementById('cash-amt').value) || 0; document.getElementById('change-due').textContent = `Change: R${(cash-total).toFixed(2)}`; }
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
        function openStockIn(k) { selectedStockKey = k; document.getElementById('stock-item-name').textContent = inventory[k].name; document.getElementById('stock-modal').style.display = 'block'; }
        function confirmStockAdd() { const a = parseFloat(document.getElementById('stock-add-amt').value); if(a) { inventory[selectedStockKey].stock += a; save(); renderStock(); closeModal(); } }
        function deleteMenuBtn(e, k) { e.stopPropagation(); if(confirm("Delete?")) { delete inventory[k]; save(); renderPOS(); } }
        function deleteCurrentTransaction() { if(confirm("Void?")) { transactions.splice(currentTransIdx, 1); if(transactions.filter(t => t.status === 'active').length === 0) createNewTransaction(); else currentTransIdx = 0; save(); renderPOS(); } }
        function saveNewProduct() {
            const name = document.getElementById('m-name').value.toUpperCase(), price = parseFloat(document.getElementById('m-price').value), cost = parseFloat(document.getElementById('m-cost').value) || 0, cat = document.getElementById('m-cat').value;
            const id = "P_" + Date.now(); inventory[id] = { name, price, cost, category: cat, stock: 0 };
            save(); location.reload();
        }
    </script>
</body>
</html>
